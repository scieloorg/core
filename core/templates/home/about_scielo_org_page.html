{% extends "base.html" %}
{% load humanize static i18n wagtailsettings_tags wagtailcore_tags get_journals_by_name_institutiton %}
{% load wagtailcore_tags %}

{% block title %}{{page.specific.title}}{% endblock title %}

{% block content %}
<style>
.scielo-list {
    max-width: 800px;
    margin: 0 auto;
    padding: 0;
}

.scielo-list-item {
    border: none;
    border-radius: 5px;
    border-bottom: 1px solid #e0e0e0;
    padding: 18px 24px;
    font-size: 15px;
    color: #333;
    transition: background 0.2s, color 0.2s;
    cursor: pointer;
}

.scielo-list-item:last-child {
    border-bottom: none;
}

.scielo-list-item a {
    color: inherit;
    text-decoration: none;
    display: block;
    width: 100%;
    height: 100%;
}

.scielo-list-item:hover,
.scielo-list-item:focus,
.scielo-list-item.active {
    background: #7b97d9;
    color: #fff;
}

.scielo-list-text {
    background: #fff;
    color: #555;
    font-style: italic;
}

.document-highlight {
    background: #f8f9fa;
    border: 2px solid #28a745;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    text-align: center;
}

.document-highlight a {
    color: #28a745;
    text-decoration: none;
    font-weight: bold;
    font-size: 16px;
}

.document-highlight a:hover {
    text-decoration: underline;
}

@media (max-width: 576px) {
    .scielo-list-item {
        padding: 15px 20px;
        font-size: 14px;
    }
}

/* Container geral do item */
.faq-item {
  border-bottom: 1px solid #e5e7eb;
  padding: 12px 0;
}

/* Botão/pergunta */
.faq-question {
  all: unset;                 /* Remove estilos default (equivalente a button reset) */
  display: flex;
  align-items: center;
  justify-content: space-between;
  width: 100%;
  cursor: pointer;
  font-weight: 600;
  color: #111827;
  padding: 12px 0;
}

/* Ícone de seta (chevron) */
.faq-icon {
  width: 12px;
  height: 12px;
  margin-left: 12px;
  position: relative;
  transition: transform 0.25s ease;
}
.faq-icon::before,
.faq-icon::after {
  content: "";
  position: absolute;
  right: 0;
  top: 50%;
  width: 8px;
  height: 2px;
  background: #6b7280; /* cor do ícone */
  transform-origin: right center;
}
.faq-icon::before { transform: translateY(-1px) rotate(35deg); }
.faq-icon::after  { transform: translateY(-1px) rotate(-35deg); }
/* Rotaciona para “abrir” (vira um X > V) quando expandido */
.faq-question[aria-expanded="true"] .faq-icon {
  transform: rotate(90deg);
}

/* Corpo/resposta (colapsado por padrão) */
.faq-body {
  overflow: hidden;
  height: 0;
  opacity: 0;
  transition: height 0.25s ease, opacity 0.2s ease;
}
.faq-item.is-open .faq-body {
  opacity: 1;
}

/* Acessibilidade foco */
.faq-question:focus-visible {
  outline: 2px solid #2563eb;
  outline-offset: 2px;
}
.page-updated-at {
    font-size: .75em;
    color: #7f7a71;
    text-align: right;
    padding: 0 10px 17px;
}

</style>
    {% include "home/scieloorg/header.html" %}

    <div class="container">
        <div class="row">
            <div class="col text-center">
                <a href="{{ page.get_parent.specific.url }}">
                    <div class="scielo__logo-scielo--medium"></div>
                </a>
            </div>
        </div>
    </div>

    {% include "home/include/list_journal_page/breadcrumb.html" %}
    <section>
        <div class="container my-3">
            <div class="row justify-content-end">
                <div class="col-12 col-md-6 col-lg-4">
                    <form name="searchForm" id="searchForm" action="" method="get">
                            <div class="input-group mb-3 mt-4">
                                <input type="search"
                                    class="form-control"
                                    name="q"
                                    value="{{ q|default:'' }}"
                                    placeholder="Buscar páginas Sobre SciELO"
                                    aria-label="Buscar páginas" />
                                <button type="submit"
                                        class="btn btn-primary btn-lg scielo__btn-with-icon--only">
                                    <i class="material-icons-outlined">search</i>
                                </button>
                            </div>
                        </form>
                </div>
            </div>
        </div>

        <div class="container">
            {% if q %}
                <p style="margin-top:10px;">
                    Resultados para: <strong>{{ q }}</strong>
                </p>
                {% if search_results %}
                    <div class="search-results">
                        {% for result in search_results %}
                            <div class="scielo-list-item">
                                <a href="{% pageurl result %}">{{ result.title }}</a>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p>Nenhum resultado encontrado.</p>
                {% endif %}
            {% else %}
                {% if page.external_link %}
                    <script>
                  window.open("{{ page.external_link }}", "_blank");
                  window.location.href = "{{ page.external_link }}";
                    </script>
                    <p style="text-align: center; margin: 40px 0;">
                        Redirecionando para <a href="{{ page.external_link }}"
    target="_blank"
    rel="noopener noreferrer">{{ page.external_link }}</a>...
                    </p>
                {% else %}
                    {# Mostrar documento principal destacado #}
                    {% if page.attached_document %}
                        <div class="document-highlight">
                            <a href="{{ page.attached_document.url }}"
                               target="_blank"
                               rel="noopener noreferrer">{{ page.attached_document.title }}</a>
                            <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                {% if page.attached_document.file_extension %}{{ page.attached_document.file_extension|upper }}{% endif %}
                                {% if page.attached_document.file_size %}• {{ page.attached_document.file_size|filesizeformat }}{% endif %}
                            </div>
                        </div>
                    {% endif %}
                    {# Conteúdo principal da página #}
                    {% if page.body %}
                        <div class="container">
                            <div class="page-updated-at">
                                ({{page.updated}})
                            </div>
                        </div>
                    <div class="scielo-list-text">{{ page.body|richtext }}</div>{% endif %}
                    {# Lista de itens do StreamField #}
                    {% for block in page.list_page %}
                        {% if block.block_type == 'faq_item' %}
                            <div class="faq-item" data-faq>
                                <button class="faq-question"
                                        type="button"
                                        aria-expanded="false"
                                        aria-controls="faq-body-{{ forloop.counter }}"
                                        id="faq-question-{{ forloop.counter }}">
                                    <span class="faq-question-text">{{ block.value.question }} ({{ page.last_published_at }})</span>
                                    <span class="faq-icon" aria-hidden="true"></span>
                                </button>
                                <div class="faq-body"
                                     id="faq-body-{{ forloop.counter }}"
                                     role="region"
                                     aria-labelledby="faq-question-{{ forloop.counter }}">
                                    {{ block.value.body|richtext }}
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                {% endif %}
                {# Páginas filhas #}
                {% for child in page.get_children.live.public %}
                    <div class="scielo-list-item">
                        <a href="{% pageurl child %}">{{ child.title }}</a>
                    </div>
                {% endfor %}
            {% endif %}
        </div>
    </section>
    <script>
  (function () {
    function openBody(body) {
      body.style.height = body.scrollHeight + 'px';
      body.addEventListener('transitionend', function onEnd() {
        body.style.height = 'auto';
        body.removeEventListener('transitionend', onEnd);
      });
    }
    function closeBody(body) {
      body.style.height = body.scrollHeight + 'px'; // set start height
      // force reflow
      body.offsetHeight;
      body.style.height = '0px';
    }
    function toggleFAQ(item) {
      const btn = item.querySelector('.faq-question');
      const body = item.querySelector('.faq-body');
      const isOpening = !item.classList.contains('is-open');
      item.classList.toggle('is-open', isOpening);
      btn.setAttribute('aria-expanded', String(isOpening));
      if (isOpening) {
        body.style.height = '0px';
        // next frame
        requestAnimationFrame(() => openBody(body));
      } else {
        closeBody(body);
      }
    }

    document.addEventListener('click', function(e) {
      const btn = e.target.closest('.faq-question');
      if (!btn) return;
      const item = btn.closest('[data-faq]');
      if (!item) return;
      toggleFAQ(item);
    });
  })();
    </script>
{% endblock %}
